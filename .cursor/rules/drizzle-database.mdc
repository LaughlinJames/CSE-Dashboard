---
alwaysApply: true
---
# Drizzle ORM Database Interactions

All database interactions in this project **must** use Drizzle ORM with the schema and queries defined in [src/db/schema.ts](mdc:src/db/schema.ts).

## Schema Location

- **Database schema**: [src/db/schema.ts](mdc:src/db/schema.ts)
- All table definitions are exported from this file
- Currently defined tables: `customersTable`, `customerNotesTable`

## Guidelines

### 1. Always Import from Schema

```typescript
import { customersTable, customerNotesTable } from "@/db/schema";
```

### 2. Use Drizzle Query Syntax

Always use Drizzle's query builder methods instead of raw SQL:

```typescript
// ✅ Correct - Use Drizzle queries
import { db } from "@/db";
import { customersTable, customerNotesTable } from "@/db/schema";
import { eq } from "drizzle-orm";

// Select customers for a user
const customers = await db
  .select()
  .from(customersTable)
  .where(eq(customersTable.userId, userId));

// Get a specific customer
const customer = await db
  .select()
  .from(customersTable)
  .where(eq(customersTable.id, 1));

// Insert a customer
const newCustomer = await db
  .insert(customersTable)
  .values({
    name: "Acme Corp",
    lastPatchDate: new Date("2024-01-15"),
    topology: "prod",
    dumbledoreStage: 5,
    userId: "user_123",
  })
  .returning();

// Add a note to a customer
const newNote = await db
  .insert(customerNotesTable)
  .values({
    customerId: 1,
    note: "Initial setup completed",
    userId: "user_123",
  })
  .returning();

// Get all notes for a customer
const notes = await db
  .select()
  .from(customerNotesTable)
  .where(eq(customerNotesTable.customerId, 1));

// Update customer
await db
  .update(customersTable)
  .set({ 
    lastPatchDate: new Date(),
    topology: "stage",
    dumbledoreStage: 6,
    updatedAt: new Date(),
  })
  .where(eq(customersTable.id, 1));

// Delete customer (notes will cascade delete)
await db
  .delete(customersTable)
  .where(eq(customersTable.id, 1));
```

### 3. Never Use Raw SQL

```typescript
// ❌ Incorrect - Do not use raw SQL queries
await db.execute("SELECT * FROM customers");
```

### 4. Type Safety

- Leverage Drizzle's type inference for type-safe queries
- Use `$inferInsert` and `$inferSelect` for type definitions:

```typescript
import { customersTable, customerNotesTable } from "@/db/schema";

// Customer types
export type InsertCustomer = typeof customersTable.$inferInsert;
export type SelectCustomer = typeof customersTable.$inferSelect;

// Customer Note types
export type InsertCustomerNote = typeof customerNotesTable.$inferInsert;
export type SelectCustomerNote = typeof customerNotesTable.$inferSelect;
```

### 5. Add New Tables to Schema

When creating new tables, always add them to [src/db/schema.ts](mdc:src/db/schema.ts) using Drizzle's table definition syntax.

## Database Connection

Ensure you have a properly configured database connection that exports a `db` instance using Drizzle's connection setup.

## Migration

Use Drizzle Kit for schema migrations:
- Generate migrations: `npx drizzle-kit generate`
- Run migrations: `npx drizzle-kit push` or `npx drizzle-kit migrate`
